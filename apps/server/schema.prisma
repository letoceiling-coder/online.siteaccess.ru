generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @default(now()) @updatedAt
  channels     Channel[]

  @@map("users")
}

model Channel {
  id                      String         @id @default(uuid())
  name                    String
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  tokenHash               String?        @unique(map: "channels_tokenhash_key")
  allowedDomains          Json?
  ownerUserId             String?
  widgetsettings          Json?
  installverifiedat       DateTime?
  lastwidgetpingat        DateTime?
  lastwidgetpingurl       String?
  lastwidgetpinguseragent String?
  encryptionmode          encryptionmode @default(server)
  owner                   User?          @relation(fields: [ownerUserId], references: [id])
  conversations           Conversation[]
  visitors                Visitor[]

  @@index([ownerUserId])
  @@map("channels")
}

model Visitor {
  id            String         @id @default(uuid())
  channelId     String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  externalId    String?        @unique(map: "visitors_externalid_key")
  lastSeenAt    DateTime       @default(now())
  conversations Conversation[]
  channel       Channel        @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId], map: "visitors_channelid_idx")
  @@index([externalId], map: "visitors_externalid_idx")
  @@map("visitors")
}

model Conversation {
  id        String    @id @default(uuid())
  channelId String
  visitorId String
  status    String    @default("active")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  channel   Channel   @relation(fields: [channelId], references: [id], onDelete: Cascade)
  visitor   Visitor   @relation(fields: [visitorId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@index([channelId])
  @@index([visitorId])
  @@map("conversations")
}

model Message {
  id              String       @id @default(uuid())
  conversationId  String
  senderType      String
  senderId        String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  text            String?
  clientMessageId String?      @unique(map: "messages_clientmessageid_key")
  attachments     Attachment[]
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@index([conversationId], map: "messages_conversationid_idx")
  @@index([createdAt], map: "messages_createdat_idx")
  @@map("messages")
}

model Attachment {
  id        String   @id @default(uuid())
  messageId String
  url       String
  type      String
  fileSize  Int?
  mimeType  String?
  createdAt DateTime @default(now())
  fileName  String?
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@map("attachments")
}

enum encryptionmode {
  none
  server
  e2ee
}
